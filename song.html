<!DOCTYPE html>
<html lang="zh-Hans">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="./reset.css">
    <link rel="stylesheet" href="./song.css">
    <title>播放</title>
</head>

<body>
    <div class="page">
        <div class="bg">
            <img src="http://oxkl41ihc.bkt.clouddn.com/%E7%90%86%E6%83%B3%E4%B8%89%E6%97%AC%20%28Live%29.jpg" alt="">
        </div>
        <section class="pointer"></section>
        <section class="logo"></section>
        <section class="disk">
            <div class="circle playing">
                <div class="icon-wrapper">
                    <svg class="icon icon-play" aria-hidden="true">
                        <use xlink:href="#icon-bofang"></use>
                    </svg>
                    <svg class="icon icon-pause" aria-hidden="true">
                        <use xlink:href="#icon-pause"></use>
                    </svg>
                </div>
                <img src="http://oxkl41ihc.bkt.clouddn.com/%E7%90%86%E6%83%B3%E4%B8%89%E6%97%AC%20%28Live%29.jpg" alt="">
            </div>
        </section>
        <section class="lyric-wrap">
            <h1>歌名 - 歌手</h1>
            <div class="lyric">
                <div class="lines"></div>
            </div>
        </section>
        <section class="links">
            <a id=open href="#">打开</a>
            <a href="#">下载</a>
        </section>
    </div>
    <script src="./vendors/jquery.min.js"></script>
    <script src="./vendors/av-min.js"></script>
    <script src="./scripts/av.js"></script>
    <script src="//at.alicdn.com/t/font_434816_2feob8a2naw3tyb9.js"></script>
    <script>
        function GetQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);  //获取url中"?"符后的字符串并正则匹配
            var context = "";
            if (r != null)
                context = r[2];
            reg = null;
            r = null;
            return context == null || context == "" || context == "undefined" ? "" : context;
        }
        var id = GetQueryString("id");
        var query = new AV.Query('Song');
        query.get(id).then(function (song) {
            // console.log(song)
            let { url, lyric } = song.attributes
            let video = document.createElement('video')
            video.src = url;
            video.oncanplay = function () {
                video.play()
            }
            $('.icon-pause').on('click', function () {
                video.pause()
                $('.circle').addClass('pause')
            })
            $('.icon-play').on('click', function () {
                video.play()
                $('.circle').removeClass('pause')
            })

            let array = []
            var parts = lyric.split('\n')
            parts.forEach(function (string, index) {
                let xxx = string.split(']')
                xxx[0] = xxx[0].substring(1)
                let regex = /(\d+):([\d.]+)/
                let matches = xxx[0].match(regex)
                let minute = +matches[1]
                let seconds = +matches[2]

                array.push({
                    time: minute * 60 + seconds,
                    lyric: xxx[1]
                })
            })
            let $lyric = $('.lyric')
            array.map(function (object) {
                let $p = $('<p/>')
                $p.attr('data-time', object.time).text(object.lyric)
                $p.appendTo($lyric.children('.lines'))
            })

            setInterval(function(){
                let seconds = video.currentTime
                let $lines = $('.lines > p')
                let $whichLine
                for( let i = 0;i < $lines.length; i++){
                    let currentLineTime = $lines.eq(i).attr('data-time')
                    let nextLineTime = $lines.eq(i+1).attr('data-time')
                    // let bug = $lines.eq(i+1).length !== 0   最后一行bug ==  $lines[i+1] !== undefined
                    if( $lines[i+1] !== undefined && currentLineTime < seconds &&  nextLineTime > seconds ){
                        // console.log($lines[i])
                        $whichLine = $lines.eq(i)
                        break;
                    }
                }
                if($whichLine){
                    $whichLine.addClass('active').prev().removeClass('active')
                    let top = $whichLine.offset().top
                    let linesTop = $('.lines').offset().top
                    let delta = top - linesTop - $('.lyric').height()/3
                    $('.lines').css(`transform`,`translateY(-${delta}px)`)
                }
            },500)
            // console.log(array)
            // setInterval(function(){
            //     // console.log(video.currentTime)
            //     let current = video.currentTime
            //     for(let i = 0;i<array.length; i++){
            //         if(i === array.length -1){
            //             console.log(array[i].lyric)
            //         }else if(array[i].time <= current && array[i+1].time > current){
            //             console.log(array[i])
            //             break;
            //         }
            //     }
            // },500)
        })
    </script>
</body>

</html>